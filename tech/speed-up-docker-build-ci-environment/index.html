<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Speed up Docker build in CI environment 🏎 | Anis Khan</title>
<meta name=keywords content="docker,devops,python,go,continuous-delivery,continuous-integration">
<meta name=description content="&#34;If you&rsquo;re building Docker images on your laptop for tagging release, be in shame, and then change your behavior&#34; - Kelsey Hightower, 2018
 That&rsquo;s right! If you are building Docker images in your local machine, you are doing it wrong. We don&rsquo;t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle.">
<meta name=author content="Anis Khan">
<link rel=canonical href=https://aniskhan001.me/tech/speed-up-docker-build-ci-environment/>
<link crossorigin=anonymous href=/assets/css/stylesheet.d9dea5657b3fa385615af313e89f700acf8caeff78f56f13e2294c983f31febb.css integrity="sha256-2d6lZXs/o4VhWvMT6J9wCs+Mrv949W8T4ilMmD8x/rs=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://aniskhan001.me/icon/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://aniskhan001.me/icon/favicon16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://aniskhan001.me/icon/favicon32x32.png>
<link rel=apple-touch-icon href=https://aniskhan001.me/icon/apple_touch_icon.png>
<link rel=mask-icon href=https://aniskhan001.me/icon/apple_touch_icon.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HKTS2WR0QV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-HKTS2WR0QV',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Speed up Docker build in CI environment 🏎">
<meta property="og:description" content="&#34;If you&rsquo;re building Docker images on your laptop for tagging release, be in shame, and then change your behavior&#34; - Kelsey Hightower, 2018
 That&rsquo;s right! If you are building Docker images in your local machine, you are doing it wrong. We don&rsquo;t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://aniskhan001.me/tech/speed-up-docker-build-ci-environment/"><meta property="og:image" content="https://aniskhan001.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="tech">
<meta property="article:published_time" content="2020-01-14T00:00:00+00:00">
<meta property="article:modified_time" content="2020-01-14T00:00:00+00:00"><meta property="og:site_name" content="Anis Khan">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://aniskhan001.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="Speed up Docker build in CI environment 🏎">
<meta name=twitter:description content="&#34;If you&rsquo;re building Docker images on your laptop for tagging release, be in shame, and then change your behavior&#34; - Kelsey Hightower, 2018
 That&rsquo;s right! If you are building Docker images in your local machine, you are doing it wrong. We don&rsquo;t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"🧑‍💻 Tech Blogs","item":"https://aniskhan001.me/tech/"},{"@type":"ListItem","position":2,"name":"Speed up Docker build in CI environment 🏎","item":"https://aniskhan001.me/tech/speed-up-docker-build-ci-environment/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Speed up Docker build in CI environment 🏎","name":"Speed up Docker build in CI environment 🏎","description":"\u0026quot;If you\u0026rsquo;re building Docker images on your laptop for tagging release, be in shame, and then change your behavior\u0026quot; - Kelsey Hightower, 2018\n That\u0026rsquo;s right! If you are building Docker images in your local machine, you are doing it wrong. We don\u0026rsquo;t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle.","keywords":["docker","devops","python","go","continuous-delivery","continuous-integration"],"articleBody":" \"If you’re building Docker images on your laptop for tagging release, be in shame, and then change your behavior\" - Kelsey Hightower, 2018\n That’s right! If you are building Docker images in your local machine, you are doing it wrong. We don’t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle. But Docker builds in a CI environment might not be faster than our local machine if we don’t configure it properly. In this write-up, I’ll try to share my experience on how I achieved more speed building Docker images in a CI environment.\nHow do we do it from local machine? 🛠 We don’t want to be in shame. But let’s see what is it like building and pushing a Docker image from local machines to Docker registries.\nDocker uses layer caches to build. If we are building an image from a Dockerfile it will try to check if it already has cache present in the machine. If not it will build the image without any caching, but it will take a bit longer.\n Docker image building flow\n  Building docker images in the local machines take much less time to finish if we have built the same image before. That’s because Docker reuses the layers from previously built images which are currently present in our machine.\nWhat’s up with CI environments? 🏁 In a CI environment, things work a bit differently. Because each time a new machine spawns to run a corresponding job, and then destroy/clean up everything after the job is finished. Even if we are building the same image, again and again, Docker cannot use the layers from the previously built images since that was on a separate machine. So the above picture looks like this in a CI environment:\n Docker image building flow when the image doesn’t exist\n  In this scenario, there’s no “yes” path, the image doesn’t exist by default. So, there’s only one way forward to the build stage. But the process can speed up.\nHow can we achieve the speed? 🚅 To fix the issue in the above scenario, we will need a way to instruct Docker to use the cache from the previous build. We can just simply pull the latest image from our docker repository in the runner machine for each job before building the image. So that we can use the cache of the previously built image.\n Speed up Docker image building process by pulling the image first\n  To use the cache from the previously built image we can use the --cache-from option on the build command. This option will take an image name from where we want to use it as the cache source.\nConsider this Dockerfile:\nFROMpython:3.8ENV TZ=Asia/DhakaRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026\u0026 echo $TZ  /etc/timezoneWORKDIR/appADD requirements.txt .RUN pip install -r requirements.txtCOPY ./code .EXPOSE5000The process for building this Dockerfile could be the following:\n Pull the image with the latest tag Build the image with --cache-from flag to use cache from previously built layers, \u0026 create both the latest tag and our chosen tag Push both of the tags  # Step 1 docker pull docker.myrepo.com/awesome-image:latest # Step 2 docker build . --cache-from docker.myrepo.com/awesome-image:latest -t docker.myrepo.com/awesome-image:latest -t docker.myrepo.com/awesome-image:1.4.7 # Step 3 docker push docker.myrepo.com/awesome-image  What If?.. we use multi-stage Dockerfile 🐳 For multi-stage Dockerfiles, usually, there are one or more builder stages where we build the application. During the build process, the container environment can be polluted by build dependencies which might not be required for the application to run. So we pull a fresh base image in the final stage and copy over only the application files to the final stage from the previous builder stage. Thus the final build couldn’t really use the layer cache from the builder stage since the final stage is based on a different image. When some project files change it will always try to build the image and for the changes detected it won’t be able to use the cache from the latest tag. So, what do we do in this case?\nHere’s a Dockerfile with multi-stage build:\n# BUILDER STAGEARG GO_VERSION=1.12.7FROMgolang:${GO_VERSION}-alpine AS builder# Create the user and group files# that will be used in the running container# to run the process as an unprivileged userRUN mkdir /user \u0026\u0026 \\  echo 'nobody:x:65534:65534:nobody:/:'  /user/passwd \u0026\u0026 \\  echo 'nobody:x:65534:'  /user/groupWORKDIR/srcCOPY ./ ./RUN CGO_ENABLED=0 GOOS=linux go build -a -o /app .# FINAL STAGEFROMscratch AS finalCOPY --from=builder /user/group /user/passwd /etc/COPY --from=builder /app /appUSERnobody:nobodyENTRYPOINT [\"/app\"]The build process for multi-stage build would be:\n Pull the image with the builder tag Build and tag a new builder image using --target option to set the builder stage and use --cache-from option to use the layer caching. Build the final image by using cache from the builder stage and tag with the latest \u0026 our favorite tag. Push both builder, latest, and our favorite tags.  # Step 1 docker pull docker.myrepo.com/awesome-image:builder # Step 2 docker build . --target builder --cache-from docker.myrepo.com/awesome-image:builder -t docker.myrepo.com/awesome-image:builder # Step 3 docker build . --cache-from docker.myrepo.com/awesome-image:builder -t docker.myrepo.com/awesome-image:latest -t docker.myrepo.com/awesome-image:1.4.7 # Step 4 # pushes 'builder', 'latest' \u0026 '1.4.7' tags docker push docker.myrepo.com/awesome-image  Cool! But can we do some magic? 🎩 Yes, but depends on the tool. Some CI tool supports special commands or configurations to have the cache from the previous build automatically. For example, CircleCI has a configuration like this below:\nour_job_name: machine: docker_layer_caching: true That automatically does all the trick that we have done manually above.\n I tried to share how I approached and solved the issue of Docker build speed in the CI environment. Hope the readers will find these simple tips helpful and can use them to improve their build pipelines.\n","wordCount":"968","inLanguage":"en","datePublished":"2020-01-14T00:00:00Z","dateModified":"2020-01-14T00:00:00Z","author":{"@type":"Person","name":"Anis Khan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://aniskhan001.me/tech/speed-up-docker-build-ci-environment/"},"publisher":{"@type":"Organization","name":"Anis Khan","logo":{"@type":"ImageObject","url":"https://aniskhan001.me/icon/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://aniskhan001.me/ accesskey=h title="💥 Home (Alt + H)">💥 Home</a>
<span class=logo-switches>
</div>
</div>
<ul id=menu>
<li>
<a href=https://aniskhan001.me/tags/ title="tags 🏷">
<span>tags 🏷</span>
</a>
</li>
<li>
<a href=https://aniskhan001.me/search/ title="search 🔍 (Alt + /)" accesskey=/>
<span>search 🔍</span>
</a>
</li><li>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://aniskhan001.me/>💥 Home</a>
<a href=https://aniskhan001.me/tech/>🧑‍💻 Tech Blogs</a></div>
<h1 class=post-title>
Speed up Docker build in CI environment 🏎
</h1>
<div class=post-meta><span title="2020-01-14 00:00:00 +0000 UTC">January 14, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Anis Khan
</div>
</header>
<div class=post-content>
<blockquote>
<p><a href="https://youtu.be/kOa_llowQ1c?t=500">"<em>If you&rsquo;re building Docker images on your laptop for tagging release, be in shame, and then change your behavior</em>"</a> - Kelsey Hightower, 2018</p>
</blockquote>
<p>That&rsquo;s right! If you are building Docker images in your local machine, you are doing it wrong. We don&rsquo;t want to build anything on our laptop. When we are tagging a new release for production, staging, or even for a dev environment, the build should trigger automatically to save time and avoid the hassle. But Docker builds in a CI environment might not be faster than our local machine if we don&rsquo;t configure it properly. In this write-up, I&rsquo;ll try to share my experience on how I achieved more speed building Docker images in a CI environment.</p>
<h2 id=how-do-we-do-it-from-local-machine>How do we do it from local machine? 🛠<a hidden class=anchor aria-hidden=true href=#how-do-we-do-it-from-local-machine>#</a></h2>
<p>We don&rsquo;t want to be in shame. But let&rsquo;s see what is it like building and pushing a Docker image from local machines to Docker registries.</p>
<p>Docker uses layer caches to build. If we are building an image from a Dockerfile it will try to check if it already has cache present in the machine. If not it will build the image without any caching, but it will take a bit longer.</p>
<figure class=align-center>
<img loading=lazy src=/img/tech/docker-speed-1.png#center alt="Docker image building flow"> <figcaption>
<p>Docker image building flow</p>
</figcaption>
</figure>
<p>Building docker images in the local machines take much less time to finish if we have built the same image before. That&rsquo;s because Docker reuses the layers from previously built images which are currently present in our machine.</p>
<h2 id=whats-up-with-ci-environments->What&rsquo;s up with CI environments? 🏁<a hidden class=anchor aria-hidden=true href=#whats-up-with-ci-environments->#</a></h2>
<p>In a CI environment, things work a bit differently. Because each time a new machine spawns to run a corresponding job, and then destroy/clean up everything after the job is finished. Even if we are building the same image, again and again, Docker cannot use the layers from the previously built images since that was on a separate machine. So the above picture looks like this in a CI environment:</p>
<figure class=align-center>
<img loading=lazy src=/img/tech/docker-speed-2.png#center alt="Docker image building flow when the image doesn&amp;rsquo;t exist"> <figcaption>
<p>Docker image building flow when the image doesn&rsquo;t exist</p>
</figcaption>
</figure>
<p>In this scenario, there&rsquo;s no &ldquo;yes&rdquo; path, the image doesn&rsquo;t exist by default. So, there&rsquo;s only one way forward to the build stage. But the process can speed up.</p>
<h2 id=how-can-we-achieve-the-speed>How can we achieve the speed? 🚅<a hidden class=anchor aria-hidden=true href=#how-can-we-achieve-the-speed>#</a></h2>
<p>To fix the issue in the above scenario, we will need a way to instruct Docker to use the cache from the previous build. We can just simply pull the <code>latest</code> image from our docker repository in the runner machine for each job before building the image. So that we can use the cache of the previously built image.</p>
<figure class=align-center>
<img loading=lazy src=/img/tech/docker-speed-3.png#center alt="Speed up Docker image building process by pulling the image first"> <figcaption>
<p>Speed up Docker image building process by pulling the image first</p>
</figcaption>
</figure>
<p>To use the cache from the previously built image we can use the <code>--cache-from</code> option on the build command. This option will take an image name from where we want to use it as the cache source.</p>
<p>Consider this <code>Dockerfile</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#fff;font-weight:700>FROM</span><span style=color:#0ff;font-weight:700> python:3.8</span><span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>ENV</span> TZ=Asia/Dhaka<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>RUN</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; <span style=color:#fff;font-weight:700>echo</span> $TZ &gt; /etc/timezone<span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>WORKDIR</span><span style=color:#0ff;font-weight:700> /app</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>ADD</span> requirements.txt .<span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>RUN</span> pip install -r requirements.txt<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>COPY</span> ./code .<span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>EXPOSE</span><span style=color:#0ff;font-weight:700> 5000</span><span style=color:red>
</span></code></pre></div><p>The process for building this Dockerfile could be the following:</p>
<ol>
<li>Pull the image with the <code>latest</code> tag</li>
<li>Build the image with <code>--cache-from</code> flag to use cache from previously built layers, & create both the latest tag and our chosen tag</li>
<li>Push both of the tags</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#007f7f># Step 1</span>
docker pull docker.myrepo.com/awesome-image:latest

<span style=color:#007f7f># Step 2</span>
docker build .
  --cache-from docker.myrepo.com/awesome-image:latest
  -t docker.myrepo.com/awesome-image:latest
  -t docker.myrepo.com/awesome-image:1.4.7

<span style=color:#007f7f># Step 3</span>
docker push docker.myrepo.com/awesome-image
</code></pre></div><p> </p>
<h2 id=what-if-we-use-multi-stage-dockerfile->What If?.. we use multi-stage Dockerfile 🐳<a hidden class=anchor aria-hidden=true href=#what-if-we-use-multi-stage-dockerfile->#</a></h2>
<p>For multi-stage Dockerfiles, usually, there are one or more builder stages where we build the application. During the build process, the container environment can be polluted by build dependencies which might not be required for the application to run. So we pull a fresh base image in the final stage and copy over only the application files to the final stage from the previous builder stage. Thus the final build couldn&rsquo;t really use the layer cache from the builder stage since the final stage is based on a different image. When some project files change it will always try to build the image and for the changes detected it won&rsquo;t be able to use the cache from the <code>latest</code> tag. So, what do we do in this case?</p>
<p>Here&rsquo;s a <code>Dockerfile</code> with multi-stage build:</p>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#007f7f># BUILDER STAGE</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>ARG</span> GO_VERSION=<span style=color:#ff0;font-weight:700>1</span>.12.7<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>FROM</span><span style=color:#0ff;font-weight:700> golang:${GO_VERSION}-alpine AS builder</span><span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#007f7f># Create the user and group files</span><span style=color:red>
</span><span style=color:red></span><span style=color:#007f7f># that will be used in the running container</span><span style=color:red>
</span><span style=color:red></span><span style=color:#007f7f># to run the process as an unprivileged user</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>RUN</span> mkdir /user &amp;&amp; <span style=color:#0ff;font-weight:700>\
</span><span style=color:#0ff;font-weight:700></span>    <span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#39;nobody:x:65534:65534:nobody:/:&#39;</span> &gt; /user/passwd &amp;&amp; <span style=color:#0ff;font-weight:700>\
</span><span style=color:#0ff;font-weight:700></span>    <span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#39;nobody:x:65534:&#39;</span> &gt; /user/group<span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>WORKDIR</span><span style=color:#0ff;font-weight:700> /src</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>COPY</span> ./ ./<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>RUN</span> CGO_ENABLED=<span style=color:#ff0;font-weight:700>0</span> GOOS=linux go build -a -o /app .<span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#007f7f># FINAL STAGE</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>FROM</span><span style=color:#0ff;font-weight:700> scratch AS final</span><span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>COPY</span> --from=builder /user/group /user/passwd /etc/<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>COPY</span> --from=builder /app /app<span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>USER</span><span style=color:#0ff;font-weight:700> nobody:nobody</span><span style=color:red>
</span><span style=color:red>
</span><span style=color:red></span><span style=color:#fff;font-weight:700>ENTRYPOINT</span> [<span style=color:#0ff;font-weight:700>&#34;/app&#34;</span>]<span style=color:red>
</span></code></pre></div><p>The build process for multi-stage build would be:</p>
<ol>
<li>Pull the image with the <code>builder</code> tag</li>
<li>Build and tag a new <code>builder</code> image using <code>--target</code> option to set the builder stage and use <code>--cache-from</code> option to use the layer caching.</li>
<li>Build the final image by using cache from the builder stage and tag with the <code>latest</code> & our favorite tag.</li>
<li>Push both builder, latest, and our favorite tags.</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#007f7f># Step 1</span>
docker pull docker.myrepo.com/awesome-image:builder

<span style=color:#007f7f># Step 2</span>
docker build . --target builder
  --cache-from docker.myrepo.com/awesome-image:builder
  -t docker.myrepo.com/awesome-image:builder

<span style=color:#007f7f># Step 3</span>
docker build .
  --cache-from docker.myrepo.com/awesome-image:builder
  -t docker.myrepo.com/awesome-image:latest
  -t docker.myrepo.com/awesome-image:1.4.7

<span style=color:#007f7f># Step 4</span>
<span style=color:#007f7f># pushes &#39;builder&#39;, &#39;latest&#39; &amp; &#39;1.4.7&#39; tags</span>
docker push docker.myrepo.com/awesome-image
</code></pre></div><p> </p>
<h2 id=cool-but-can-we-do-some-magic>Cool! But can we do some magic? 🎩<a hidden class=anchor aria-hidden=true href=#cool-but-can-we-do-some-magic>#</a></h2>
<p>Yes, but depends on the tool. Some CI tool supports special commands or configurations to have the cache from the previous build automatically.
For example, <a href=https://circleci.com/docs/2.0/docker-layer-caching/>CircleCI</a> has a configuration like this below:</p>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=font-weight:700>our_job_name</span>:
   <span style=font-weight:700>machine</span>:
      <span style=font-weight:700>docker_layer_caching</span>: <span style=color:#fff;font-weight:700>true</span>
</code></pre></div><p>That automatically does all the trick that we have done manually above.</p>
<hr>
<p>I tried to share how I approached and solved the issue of Docker build speed in the CI environment. Hope the readers will find these simple tips helpful and can use them to improve their build pipelines.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://aniskhan001.me/tags/docker/>docker</a></li>
<li><a href=https://aniskhan001.me/tags/devops/>devops</a></li>
<li><a href=https://aniskhan001.me/tags/python/>python</a></li>
<li><a href=https://aniskhan001.me/tags/go/>go</a></li>
<li><a href=https://aniskhan001.me/tags/continuous-delivery/>continuous-delivery</a></li>
<li><a href=https://aniskhan001.me/tags/continuous-integration/>continuous-integration</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://aniskhan001.me/tech/logging-with-fluent-bit-influxdb-fig/>
<span class=title>« Prev</span>
<br>
<span>Logging with Fluent Bit & InfluxDB 🪵</span>
</a>
<a class=next href=https://aniskhan001.me/tech/easy-continuous-delivery-for-meteor-app-with-gitlab-heroku/>
<span class=title>Next »</span>
<br>
<span>Easy Continuous Delivery for Meteor app with GitLab + Heroku</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on twitter" href="https://twitter.com/intent/tweet/?text=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e&url=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f&hashtags=docker%2cdevops%2cpython%2cgo%2ccontinuous-delivery%2ccontinuous-integration"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f&title=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e&summary=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e&source=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f&title=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on whatsapp" href="https://api.whatsapp.com/send?text=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e%20-%20https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on telegram" href="https://telegram.me/share/url?text=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e&url=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Speed up Docker build in CI environment 🏎 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Speed%20up%20Docker%20build%20in%20CI%20environment%20%f0%9f%8f%8e&u=https%3a%2f%2faniskhan001.me%2ftech%2fspeed-up-docker-build-ci-environment%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg>
</a>
</div>
</footer><div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//aniskhan001.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</article>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=https://aniskhan001.me/>Anis Khan</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>